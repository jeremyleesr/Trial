<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Piano Pitch Test</title>

<style>
  body {
    margin: 0;
    background: #111;
    color: white;
    font-family: Arial, sans-serif;
    overflow: hidden;
  }

  #startBtn {
    position: absolute;
    top: 20px;
    left: 20px;
    font-size: 20px;
    padding: 10px 18px;
    background: #4CAF50;
    border: none;
    border-radius: 8px;
    color: white;
  }

  canvas {
    display: block;
  }
</style>
</head>

<body>

<button id="startBtn">Start</button>
<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const startBtn = document.getElementById("startBtn");

let audioCtx;
let pitchNode;
let currentFreq = 0;
let currentRMS = 0;

const GREEN_X = canvas.width / 2;
const GREEN_WIDTH = 80;

// ===== NOTE CONVERSION =====
function freqToNote(freq) {
  const A4 = 440;
  const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const midi = Math.round(12 * Math.log2(freq / A4) + 69);
  return noteNames[midi % 12] + Math.floor(midi / 12 - 1);
}

// ===== AUDIO INIT =====
async function initAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)({
    latencyHint: "interactive"
  });

  await audioCtx.audioWorklet.addModule("pitch-processor.js");

  const stream = await navigator.mediaDevices.getUserMedia({
    audio: {
      echoCancellation: false,
      noiseSuppression: false,
      autoGainControl: false
    }
  });

  const mic = audioCtx.createMediaStreamSource(stream);
  pitchNode = new AudioWorkletNode(audioCtx, "pitch-processor");

  pitchNode.port.onmessage = e => {
    currentFreq = e.data.frequency;
    currentRMS = e.data.rms;
  };

  mic.connect(pitchNode);
}

// ===== START BUTTON (IMPORTANT FOR iOS) =====
startBtn.onclick = async () => {
  startBtn.disabled = true;
  startBtn.textContent = "Initializing…";

  try {
    await initAudio();
    await audioCtx.resume(); // REQUIRED on iOS
    startBtn.style.display = "none";
    requestAnimationFrame(draw);
  } catch (err) {
    alert("Error: " + err.message);
    startBtn.textContent = "Reload";
    startBtn.disabled = false;
  }
};

// ===== RENDER LOOP =====
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Green zone
  ctx.fillStyle = "rgba(0,255,0,0.15)";
  ctx.fillRect(GREEN_X - GREEN_WIDTH/2, 0, GREEN_WIDTH, canvas.height);

  ctx.strokeStyle = "#00ff00";
  ctx.beginPath();
  ctx.moveTo(GREEN_X, 0);
  ctx.lineTo(GREEN_X, canvas.height);
  ctx.stroke();

  // Text
  ctx.fillStyle = "white";
  ctx.font = "20px Arial";
  ctx.fillText("RMS: " + currentRMS.toFixed(3), 20, 40);

  if (currentFreq > 0 && currentRMS > 0.02) {
    const note = freqToNote(currentFreq);
    ctx.fillText(`Note: ${note}`, 20, 80);
    ctx.fillText(`Hz: ${currentFreq.toFixed(1)}`, 20, 110);

    // Visual note dot
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(GREEN_X + 120, canvas.height/2, 12, 0, Math.PI * 2);
    ctx.fill();

    // Hit indicator
    ctx.fillStyle = "#00ff00";
    ctx.beginPath();
    ctx.arc(GREEN_X, canvas.height/2, 12, 0, Math.PI * 2);
    ctx.fill();
  } else {
    ctx.fillText("Play a piano key…", 20, 80);
  }

  requestAnimationFrame(draw);
}
</script>
</body>
</html>
