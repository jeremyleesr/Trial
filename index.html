<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Piano Hero â€“ Visual Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #1e1e1e;
    overflow: hidden;
    font-family: system-ui, sans-serif;
  }

  #ui {
    position: absolute;
    top: 12px;
    left: 12px;
    z-index: 10;
  }

  button {
    font-size: 18px;
    padding: 10px 16px;
    cursor: pointer;
  }

  canvas {
    display: block;
  }
</style>
</head>
<body>

<div id="ui">
  <button id="startBtn">START</button>
</div>

<canvas id="game"></canvas>

<script>
/* =========================
   BASIC SETUP
========================= */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* =========================
   LAYOUT CONSTANTS
========================= */

const STAFF_AREA_RATIO = 0.22;
const STAFF_TOP = () => canvas.height * (1 - STAFF_AREA_RATIO);
const STAFF_HEIGHT = () => canvas.height * STAFF_AREA_RATIO;

const HIT_ZONE_X = () => canvas.width * 0.25;
const HIT_ZONE_WIDTH = 16;

const NOTE_SPEED = 180;

/* =========================
   STAFF POSITIONS
========================= */

function trebleY() {
  return STAFF_TOP() + STAFF_HEIGHT() * 0.32;
}
function bassY() {
  return STAFF_TOP() + STAFF_HEIGHT() * 0.72;
}
function lineGap() {
  return STAFF_HEIGHT() * 0.06;
}

/* =========================
   GAME STATE
========================= */

let notes = [];
let particles = [];
let started = false;
let lastSpawn = 0;
let spawnIndex = 0;

/* =========================
   NOTE SPAWN
========================= */

function spawnNote() {
  const treble = spawnIndex % 2 === 0;
  notes.push({
    x: canvas.width + 40,
    y: treble ? trebleY() : bassY(),
    staff: treble ? "treble" : "bass",
    state: "pending",
    judged: false,
    frozen: false,
    flashCount: 0,
    flashTimer: 0,
    autoHit: spawnIndex % 3 === 0
  });
  spawnIndex++;
}

/* =========================
   DRAW HELPERS
========================= */

function drawStaff(centerY) {
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 2;
  for (let i = -2; i <= 2; i++) {
    const y = centerY + i * lineGap();
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
    ctx.stroke();
  }
}

function drawNote(note) {
  ctx.save();

  let color = "#000";
  if (note.state === "hit") color = "#2ecc71";
  if (note.state === "miss" && note.flashCount % 2 === 0) color = "#ff3b3b";

  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.ellipse(note.x, note.y, 10, 7, -0.4, 0, Math.PI * 2);
  ctx.fill();

  ctx.strokeStyle = color;
  ctx.beginPath();
  ctx.moveTo(note.x + 8, note.y);
  ctx.lineTo(note.x + 8, note.y - 35);
  ctx.stroke();

  ctx.restore();
}

function spawnParticles(x, y) {
  for (let i = 0; i < 12; i++) {
    particles.push({
      x,
      y,
      vx: (Math.random() - 0.5) * 220,
      vy: (Math.random() - 0.5) * 220,
      life: 0.35
    });
  }
}

/* =========================
   UPDATE LOOP
========================= */

let lastTime = performance.now();

function update(now) {
  const dt = (now - lastTime) / 1000;
  lastTime = now;

  if (started && now - lastSpawn > 900) {
    spawnNote();
    lastSpawn = now;
  }

  notes.forEach(note => {
    if (!note.frozen) {
      note.x -= NOTE_SPEED * dt;
    }

    if (!note.judged && note.x <= HIT_ZONE_X() + HIT_ZONE_WIDTH / 2) {
      note.judged = true;
      note.frozen = true;

      if (note.autoHit) {
        note.state = "hit";
      } else {
        note.state = "miss";
        note.flashCount = 12;
        note.flashTimer = 0.18;
      }
    }

    if (note.state === "miss" && note.flashCount > 0) {
      note.flashTimer -= dt;
      if (note.flashTimer <= 0) {
        note.flashCount--;
        note.flashTimer = 0.18 * (note.flashCount / 12);
        if (note.flashCount === 0) {
          spawnParticles(note.x, note.y);
        }
      }
    }
  });

  notes = notes.filter(n =>
    n.state !== "miss" || n.flashCount > 0
  );

  particles.forEach(p => {
    p.x += p.vx * dt;
    p.y += p.vy * dt;
    p.life -= dt;
  });
  particles = particles.filter(p => p.life > 0);

  draw();
  requestAnimationFrame(update);
}

/* =========================
   DRAW LOOP
========================= */

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Incoming area
  ctx.fillStyle = "#2b2b2b";
  ctx.fillRect(0, 0, canvas.width, STAFF_TOP());

  // Staff background
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, STAFF_TOP(), canvas.width, STAFF_HEIGHT());

  // Hit zone (ONLY staff area)
  ctx.fillStyle = "rgba(0,255,0,0.15)";
  ctx.fillRect(
    HIT_ZONE_X() - HIT_ZONE_WIDTH / 2,
    STAFF_TOP(),
    HIT_ZONE_WIDTH,
    STAFF_HEIGHT()
  );

  // Staff lines
  drawStaff(trebleY());
  drawStaff(bassY());

  // Notes
  notes.forEach(drawNote);

  // Particles
  ctx.fillStyle = "#ff3b3b";
  particles.forEach(p => {
    ctx.globalAlpha = Math.max(p.life, 0);
    ctx.fillRect(p.x, p.y, 3, 3);
  });
  ctx.globalAlpha = 1;
}

/* =========================
   UI
========================= */

document.getElementById("startBtn").onclick = () => {
  notes.length = 0;
  particles.length = 0;
  spawnIndex = 0;
  started = true;
};

requestAnimationFrame(update);
</script>

</body>
</html>
