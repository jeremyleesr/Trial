<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Piano Timing Test</title>

<style>
    body {
        margin: 0;
        background: #111;
        color: white;
        font-family: Arial, sans-serif;
        overflow: hidden;
    }

    #startBtn {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 24px;
        padding: 16px 32px;
        background: #4CAF50;
        border: none;
        border-radius: 8px;
        color: black;
        font-weight: bold;
    }

    canvas {
        display: block;
        margin: auto;
        background: #1e1e1e;
    }
</style>
</head>

<body>

<canvas id="canvas" width="900" height="420"></canvas>
<button id="startBtn">Start Timing Test</button>

<script>
/* ======================
   DEBUG CONTROLS
====================== */
const DEBUG_SIMULATE = true; // <<< important

/* ======================
   CANVAS SETUP
====================== */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const HIT_X = 150;
const GREEN_WIDTH = 100;
const SCROLL_TIME = 2000;

/* ======================
   MUSICAL STAFF
====================== */
const STAFF_CENTER_Y = 220;
const LINE_SPACING = 14;

// Treble clef mapping (C4â€“A4)
const NOTE_Y = {
    'C4': STAFF_CENTER_Y + LINE_SPACING * 3,
    'D4': STAFF_CENTER_Y + LINE_SPACING * 2.5,
    'E4': STAFF_CENTER_Y + LINE_SPACING * 2,
    'F4': STAFF_CENTER_Y + LINE_SPACING * 1.5,
    'G4': STAFF_CENTER_Y + LINE_SPACING * 1,
    'A4': STAFF_CENTER_Y + LINE_SPACING * 0.5
};

/* ======================
   SONG DATA (TEST)
====================== */
const NOTES = [
    { note: 'E4', time: 1000 },
    { note: 'D4', time: 1600 },
    { note: 'C4', time: 2200 },
    { note: 'D4', time: 2800 },
    { note: 'E4', time: 3400 },
    { note: 'E4', time: 4000 },
    { note: 'E4', time: 4600 }
].map(n => ({ ...n, state: 'pending' }));

let startTime = 0;
let playing = false;

/* ======================
   DRAWING
====================== */
function drawStaff() {
    ctx.strokeStyle = '#aaa';
    ctx.lineWidth = 1;

    for (let i = -2; i <= 2; i++) {
        ctx.beginPath();
        ctx.moveTo(0, STAFF_CENTER_Y + i * LINE_SPACING);
        ctx.lineTo(canvas.width, STAFF_CENTER_Y + i * LINE_SPACING);
        ctx.stroke();
    }
}

function drawGreenZone() {
    ctx.fillStyle = 'rgba(0,255,0,0.15)';
    ctx.fillRect(
        HIT_X - GREEN_WIDTH / 2,
        0,
        GREEN_WIDTH,
        canvas.height
    );

    ctx.strokeStyle = '#00ff00';
    ctx.beginPath();
    ctx.moveTo(HIT_X, 0);
    ctx.lineTo(HIT_X, canvas.height);
    ctx.stroke();
}

function drawNote(x, y, state) {
    ctx.fillStyle =
        state === 'hit' ? '#00ff00' :
        state === 'missed' ? '#ff4444' :
        '#ffffff';

    ctx.beginPath();
    ctx.ellipse(x, y, 12, 9, 0, 0, Math.PI * 2);
    ctx.fill();
}

/* ======================
   GAME LOOP
====================== */
function update(elapsed) {
    const HIT_WINDOW = 180;

    for (const n of NOTES) {
        if (n.state !== 'pending') continue;

        const dt = elapsed - n.time;

        // Simulated perfect hit
        if (DEBUG_SIMULATE && Math.abs(dt) < 40) {
            n.state = 'hit';
        }

        // Miss
        else if (dt > HIT_WINDOW) {
            n.state = 'missed';
        }
    }
}

function render(elapsed) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    drawGreenZone();
    drawStaff();

    for (const n of NOTES) {
        const timeUntil = n.time - elapsed;
        const x = HIT_X + timeUntil * ((canvas.width - HIT_X) / SCROLL_TIME);

        if (x < -50 || x > canvas.width + 50) continue;

        drawNote(x, NOTE_Y[n.note], n.state);
    }
}

function loop(ts) {
    if (!playing) return;

    const elapsed = ts - startTime;
    update(elapsed);
    render(elapsed);
    requestAnimationFrame(loop);
}

/* ======================
   START
====================== */
document.getElementById('startBtn').onclick = () => {
    startTime = performance.now();
    playing = true;
    document.getElementById('startBtn').style.display = 'none';
    requestAnimationFrame(loop);
};
</script>
</body>
</html>
