<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Visual Grand Staff â€“ v1.3</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #111;
  color: #e8fff2;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  height: 100%;
  overflow: hidden;
}

/* ---------- UI ---------- */
#ui {
  position: absolute;
  top: 14px;
  left: 14px;
  z-index: 10;
}

#startBtn {
  background: #3fbf6b;
  color: #000;
  border: none;
  border-radius: 14px;
  padding: 10px 18px;
  font-size: 16px;
  font-weight: 600;
}

#label {
  margin-top: 8px;
  font-size: 14px;
  opacity: 0.9;
}

/* ---------- Canvas ---------- */
canvas {
  position: absolute;
  left: 0;
  bottom: 0;
}
</style>
</head>

<body>

<div id="ui">
  <button id="startBtn">START</button>
  <div id="label">Visual grand staff test (v1.3)</div>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let notes = [];
let running = false;

/* ---------- Layout Constants ---------- */
const STAFF_ZONE_RATIO = 0.22;   // bottom 22% of screen
const STAFF_LINES = 5;
const LINE_GAP = 10;             // tight, phone-friendly
const STAFF_GAP = 22;            // gap between treble & bass
const NOTE_RADIUS_X = 6;
const NOTE_RADIUS_Y = 4;
const STEM_HEIGHT = 26;
const SCROLL_SPEED = 60;

/* ---------- Resize ---------- */
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ---------- Staff Geometry ---------- */
function getStaffMetrics() {
  const staffZoneHeight = canvas.height * STAFF_ZONE_RATIO;
  const staffZoneTop = canvas.height - staffZoneHeight;

  const staffHeight = (STAFF_LINES - 1) * LINE_GAP;
  const grandStaffHeight = staffHeight * 2 + STAFF_GAP;

  const centerY = staffZoneTop + staffZoneHeight / 2;

  const trebleTop = centerY - grandStaffHeight / 2;
  const bassTop = trebleTop + staffHeight + STAFF_GAP;

  return { trebleTop, bassTop, staffHeight };
}

/* ---------- Notes ---------- */
function spawnNotes() {
  notes = [
    { pitch: 2, x: canvas.width + 40 },
    { pitch: 4, x: canvas.width + 140 },
    { pitch: 6, x: canvas.width + 240 },
    { pitch: 8, x: canvas.width + 340 },
    { pitch: 10, x: canvas.width + 440 }
  ];
}

/* ---------- Drawing ---------- */
function drawStaff(topY) {
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 1.5;

  for (let i = 0; i < STAFF_LINES; i++) {
    const y = topY + i * LINE_GAP;
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
    ctx.stroke();
  }
}

function drawNote(x, y, up=true) {
  ctx.fillStyle = "#000";

  // note head
  ctx.beginPath();
  ctx.ellipse(x, y, NOTE_RADIUS_X, NOTE_RADIUS_Y, -0.4, 0, Math.PI * 2);
  ctx.fill();

  // stem
  ctx.beginPath();
  if (up) {
    ctx.moveTo(x + NOTE_RADIUS_X - 1, y);
    ctx.lineTo(x + NOTE_RADIUS_X - 1, y - STEM_HEIGHT);
  } else {
    ctx.moveTo(x - NOTE_RADIUS_X + 1, y);
    ctx.lineTo(x - NOTE_RADIUS_X + 1, y + STEM_HEIGHT);
  }
  ctx.stroke();
}

/* ---------- Loop ---------- */
function update(dt) {
  for (const n of notes) {
    n.x -= SCROLL_SPEED * dt;
  }
}

function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const { trebleTop, bassTop, staffHeight } = getStaffMetrics();

  // staff zone background
  ctx.fillStyle = "#f8f8f8";
  ctx.fillRect(
    0,
    canvas.height - canvas.height * STAFF_ZONE_RATIO,
    canvas.width,
    canvas.height * STAFF_ZONE_RATIO
  );

  // draw staves
  drawStaff(trebleTop);
  drawStaff(bassTop);

  // notes
  for (const n of notes) {
    const staffY =
      n.pitch < 6
        ? trebleTop + staffHeight - n.pitch * (LINE_GAP / 2)
        : bassTop + staffHeight - (n.pitch - 6) * (LINE_GAP / 2);

    drawNote(n.x, staffY, n.pitch < 6);
  }
}

let lastTime = 0;
function loop(time) {
  if (!running) return;
  const dt = (time - lastTime) / 1000;
  lastTime = time;
  update(dt);
  render();
  requestAnimationFrame(loop);
}

/* ---------- Start ---------- */
document.getElementById("startBtn").onclick = () => {
  if (running) return;
  spawnNotes();
  running = true;
  lastTime = performance.now();
  requestAnimationFrame(loop);
};
</script>

</body>
</html>
