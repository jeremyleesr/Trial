<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Piano Pitch Test</title>

<style>
body {
    margin: 0;
    background: #111;
    color: white;
    font-family: Arial, sans-serif;
}

#container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
}

canvas {
    background: #222;
    border: 2px solid #555;
}

button {
    font-size: 26px;
    padding: 18px 40px;
    margin-top: 20px;
    background: #4CAF50;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    color: white;
}
</style>
</head>

<body>
<div id="container">
    <canvas id="canvas" width="700" height="260"></canvas>
    <button id="startBtn">Start</button>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const startBtn = document.getElementById("startBtn");

// Build piano note table (A0 → C8)
const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const NOTES = [];

for (let midi = 21; midi <= 108; midi++) {
    const freq = 440 * Math.pow(2, (midi - 69) / 12);
    NOTES.push({
        freq,
        name: NOTE_NAMES[midi % 12] + (Math.floor(midi / 12) - 1)
    });
}

function snapToNote(freq) {
    let best = null;
    let minDiff = Infinity;
    for (const n of NOTES) {
        const diff = Math.abs(freq - n.freq);
        if (diff < minDiff) {
            minDiff = diff;
            best = n;
        }
    }
    return best;
}

let stableNote = null;
let stableFrames = 0;
let rms = 0;

startBtn.onclick = async () => {
    startBtn.textContent = "Initializing…";
    startBtn.disabled = true;

    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        await audioContext.resume();

        await audioContext.audioWorklet.addModule("./pitch-worklet.js");

        const stream = await navigator.mediaDevices.getUserMedia({
            audio: {
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false
            }
        });

        const mic = audioContext.createMediaStreamSource(stream);
        const node = new AudioWorkletNode(audioContext, "pitch-worklet");

        const silent = audioContext.createGain();
        silent.gain.value = 0;

        mic.connect(node);
        node.connect(silent);
        silent.connect(audioContext.destination);

        node.port.onmessage = e => {
            rms = e.data.rms || 0;

            if (e.data.frequency) {
                const snapped = snapToNote(e.data.frequency);

                if (stableNote && snapped.name === stableNote.name) {
                    stableFrames++;
                } else {
                    stableFrames = 0;
                }

                if (stableFrames >= 2) {
                    stableNote = snapped;
                }
            } else {
                stableFrames = 0;
            }
        };

        startBtn.style.display = "none";
        requestAnimationFrame(draw);

    } catch (err) {
        alert("Error – Reload\n\n" + err.message);
        startBtn.textContent = "Error – Reload";
        startBtn.disabled = false;
        console.error(err);
    }
};

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#fff";
    ctx.font = "22px Arial";

    ctx.fillText(`RMS: ${rms.toFixed(3)}`, 20, 40);

    if (stableNote) {
        ctx.fillText(`Note: ${stableNote.name}`, 20, 110);
        ctx.fillText(`Freq: ${stableNote.freq.toFixed(1)} Hz`, 20, 150);
    } else {
        ctx.fillText("Play a piano key…", 20, 120);
    }

    requestAnimationFrame(draw);
}
</script>
</body>
</html>
