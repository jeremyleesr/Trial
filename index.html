<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Piano Pitch Core</title>

<style>
body {
    margin: 0;
    background: #111;
    color: white;
    font-family: Arial, sans-serif;
}
#wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
}
canvas {
    background: #222;
    border: 2px solid #555;
}
button {
    font-size: 26px;
    padding: 18px 40px;
    margin-top: 20px;
    background: #4CAF50;
    border: none;
    border-radius: 10px;
    color: white;
    font-weight: bold;
}
</style>
</head>

<body>
<div id="wrap">
    <canvas id="c" width="700" height="300"></canvas>
    <button id="btn">Start</button>
</div>

<script>
/* ===========================
   DEBUG SWITCH
   =========================== */
const DEBUG_SIMULATE = false; // set TRUE to test without mic

/* ===========================
   CANVAS
   =========================== */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const btn = document.getElementById("btn");

/* ===========================
   NOTE TABLE
   =========================== */
const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const NOTES = [];

for (let midi = 21; midi <= 108; midi++) {
    const freq = 440 * Math.pow(2, (midi - 69) / 12);
    NOTES.push({
        name: NOTE_NAMES[midi % 12] + (Math.floor(midi / 12) - 1),
        freq
    });
}

/* ===========================
   SNAP WITH HARMONIC BIAS FIX
   =========================== */
function snapToNote(freq) {
    let best = null;
    let minScore = Infinity;

    for (const n of NOTES) {
        const diff = Math.abs(freq - n.freq);
        const penalty = n.freq > freq ? diff * 1.2 : diff;

        if (penalty < minScore) {
            minScore = penalty;
            best = n;
        }
    }
    return best;
}

/* ===========================
   STATE
   =========================== */
let rms = 0;
let detectedNote = null;
let lastNote = null;
let stableFrames = 0;

// Simulation
const SIM_NOTES = ["C4", "E4", "G4", "E4"];
let simIndex = 0;
let simTimer = 0;

/* ===========================
   AUDIO START
   =========================== */
btn.onclick = async () => {
    btn.textContent = "Initializing…";
    btn.disabled = true;

    if (!DEBUG_SIMULATE) {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        await audioContext.resume();

        await audioContext.audioWorklet.addModule("./pitch-worklet.js");

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mic = audioContext.createMediaStreamSource(stream);

        const node = new AudioWorkletNode(audioContext, "pitch-worklet");
        const silent = audioContext.createGain();
        silent.gain.value = 0;

        mic.connect(node);
        node.connect(silent);
        silent.connect(audioContext.destination);

        node.port.onmessage = e => {
            rms = e.data.rms || 0;

            if (e.data.frequency) {
                const snapped = snapToNote(e.data.frequency);

                if (lastNote && snapped.name === lastNote.name) {
                    stableFrames++;
                } else {
                    stableFrames = 0;
                }

                if (stableFrames >= 2) {
                    detectedNote = snapped;
                    lastNote = snapped;
                }
            } else {
                stableFrames = 0;
            }
        };
    }

    btn.style.display = "none";
    draw();
};

/* ===========================
   DRAW LOOP
   =========================== */
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#fff";
    ctx.font = "22px Arial";

    // Simulation mode
    if (DEBUG_SIMULATE) {
        simTimer++;
        if (simTimer > 60) {
            simTimer = 0;
            detectedNote = { name: SIM_NOTES[simIndex], freq: 0 };
            simIndex = (simIndex + 1) % SIM_NOTES.length;
        }
    }

    ctx.fillText(`RMS: ${rms.toFixed(3)}`, 20, 40);

    if (detectedNote) {
        ctx.fillText(`Detected Note: ${detectedNote.name}`, 20, 110);
    } else {
        ctx.fillText("Play a piano key…", 20, 110);
    }

    requestAnimationFrame(draw);
}
</script>
</body>
</html>
