<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Piano Pitch Test</title>

<style>
body {
    margin: 0;
    background: #1a1a1a;
    color: white;
    font-family: Arial, sans-serif;
}
#container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
}
canvas {
    background: #2a2a2a;
    border: 2px solid #444;
}
button {
    font-size: 28px;
    padding: 18px 40px;
    margin-top: 20px;
    border-radius: 10px;
    border: none;
    background: #4CAF50;
    color: white;
    font-weight: bold;
}
</style>
</head>

<body>
<div id="container">
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <button id="startButton">Start</button>
</div>

<script>
/* =========================
   GAME STATE
========================= */
const gameState = {
    audioContext: null,
    pitchNode: null,
    currentPitch: 0,
    currentNote: null,
    isRunning: false
};

/* =========================
   CANVAS
========================= */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const startButton = document.getElementById('startButton');

/* =========================
   NOTE HELPERS
========================= */
const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

function frequencyToNote(freq) {
    const A4 = 440;
    const midi = Math.round(12 * Math.log2(freq / A4) + 69);
    const note = NOTE_NAMES[midi % 12];
    const octave = Math.floor(midi / 12) - 1;
    return `${note}${octave}`;
}

/* =========================
   AUDIO INIT
========================= */
async function initAudio() {
    startButton.disabled = true;
    startButton.textContent = "Initializing…";

    gameState.audioContext = new (window.AudioContext || window.webkitAudioContext)({
        latencyHint: "interactive"
    });

    await gameState.audioContext.resume();

    // LOAD WORKLET
    await gameState.audioContext.audioWorklet.addModule("pitch-processor.js");

    // MIC
    const stream = await navigator.mediaDevices.getUserMedia({
        audio: {
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: false
        }
    });

    const micSource = gameState.audioContext.createMediaStreamSource(stream);

    gameState.pitchNode = new AudioWorkletNode(
        gameState.audioContext,
        "pitch-processor"
    );

    // KEEP SAFARI ALIVE
    const dummyGain = gameState.audioContext.createGain();
    dummyGain.gain.value = 0;

    micSource.connect(gameState.pitchNode);
    gameState.pitchNode.connect(dummyGain);
    dummyGain.connect(gameState.audioContext.destination);

    gameState.pitchNode.port.onmessage = (e) => {
        const { frequency } = e.data;
        if (frequency > 0) {
            gameState.currentPitch = frequency;
            gameState.currentNote = frequencyToNote(frequency);
        } else {
            gameState.currentNote = null;
        }
    };

    gameState.isRunning = true;
    startButton.style.display = "none";
    requestAnimationFrame(draw);
}

/* =========================
   RENDER LOOP
========================= */
function draw() {
    if (!gameState.isRunning) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "#fff";
    ctx.font = "28px Arial";

    if (gameState.currentNote) {
        ctx.fillText(
            `Pitch: ${gameState.currentPitch.toFixed(1)} Hz`,
            20, 50
        );
        ctx.fillText(
            `Note: ${gameState.currentNote}`,
            20, 90
        );
    } else {
        ctx.fillText("Play a note…", 20, 60);
    }

    requestAnimationFrame(draw);
}

/* =========================
   BUTTON
========================= */
startButton.onclick = initAudio;
</script>
</body>
</html>
